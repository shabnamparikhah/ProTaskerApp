@model ProTasker.Models.KanbanViewModel
@{
    Layout = "_Layout";
}

<h2>Kanban Board</h2>


<div class="mb-3">
    <input type="hidden" id="projectId" value="@Model.ProjectId" />

    @if (User.Identity.IsAuthenticated)
    {
        <div class="input-group mb-3 w-50">
            <input type="text" class="form-control" id="taskTitle" placeholder="New task title..." />
            <button id="addTaskBtn" type="button" class="btn btn-primary">Add Task</button>
        </div>
    }
    else
    {
        <div class="alert alert-info w-50">
            Please log in to add tasks.
        </div>
    }
</div>


<div class="row">
    <div class="col" id="todoColumn" data-status="Todo">
        <h4>To Do</h4>
        @foreach (var task in Model.Todo)
        {
            <div class="card mb-2 p-2 bg-light task-card" draggable="true" data-id="@task.Id">
                @task.Title
            </div>
        }
    </div>
    <div class="col" id="inProgressColumn" data-status="InProgress">
        <h4>In Progress</h4>
        @foreach (var task in Model.InProgress)
        {
            <div class="card mb-2 p-2 bg-warning text-dark task-card" draggable="true" data-id="@task.Id">
                @task.Title
            </div>
        }
    </div>
    <div class="col" id="doneColumn" data-status="Done">
        <h4>Done</h4>
        @foreach (var task in Model.Done)
        {
            <div class="card mb-2 p-2 bg-success text-white task-card" draggable="true" data-id="@task.Id">
                @task.Title
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        console.log("✅ Kanban JS Loaded");

        // 🔹 Add Task
        $("#addTaskBtn").click(function () {
            var title = $("#taskTitle").val();
            var projectId = $("#projectId").val();
            if (!title.trim()) return;

            $.post("/TaskItems/Create", { title: title, projectId: projectId }, function (task) {
                $("#todoColumn").append(
                    `<div class="card mb-2 p-2 bg-light task-card" draggable="true" data-id="${task.id}">
                        ${task.title}
                    </div>`
                );
                $("#taskTitle").val("");
            });
        });

        // 🔹 Drag & Drop
        let draggedItem = null;

        $(document).on("dragstart", ".task-card", function () {
            draggedItem = this;
            setTimeout(() => $(this).hide(), 0);
        });

        $(document).on("dragend", ".task-card", function () {
            draggedItem = null;
            $(".task-card").show();
        });

        $(".col").on("dragover", function (e) { e.preventDefault(); });

        $(".col").on("drop", function (e) {
            e.preventDefault();
            if (draggedItem) {
                $(this).append(draggedItem);

                let taskId = $(draggedItem).data("id");
                let newStatus = $(this).data("status");

                $.post("/TaskItems/UpdateStatus", { id: taskId, status: newStatus });
            }
        });
    </script>
}
